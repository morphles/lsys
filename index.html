<html>
<head>
	<title>L-Systems Explorer</title>
	<script type="text/javascript" src="funcs.js"></script>
	<script type="text/javascript">
		//XXX way too many globals
		var stack = [];
		var bc;//buffer canvas
		var bw, bh;
		var px, py;
		var msx, msy;
		var w, h;
		var dragging = false;

		function putimg() {
			e('cv').getContext('2d').fillStyle = "rgba(0,0,0,1)";
			e('cv').getContext('2d').fillRect( 0 , 0 , w , h );
			e('cv').getContext('2d').rect( 0 , 0 , w , h );
			e('cv').getContext('2d').clip();
			e('cv').getContext('2d').drawImage(bc, px, py);
		}

		function make_canvas(w, h, alpha) {
			var canvas = createOffscreenCanvas(w, h);
			var ctx = canvas.getContext('2d');//XXX there some cuttoff, see with sierpinski
			ctx.fillStyle = "rgba(100,200,100," + alpha + ")";
			ctx.strokeStyle = "rgba(100,200,100," + alpha + ")";
			return canvas;
		}

		function draw_on_canvas(s, ctx, funcs, assocc, x, y, ca, l, da) {
			var i, k, func_list;
			ctx.beginPath();
			for (i = 0; i < s.length; i++) {
				func_list = assocc[s[i]];
				for (k in func_list) {
					[x, y, ca, l] = typeof funcs[func_list[k]] === 'function' ? funcs[func_list[k]](x, y, ca, l, ctx, da, 1) : [x, y, ca, l];
				}
			}
			ctx.stroke();
		}

		function draw(s, assocc) {
			var alpha = e('alpha').value;

			var dl = 1, da = Math.PI / 180 * e('deg').value;

			ca = -Math.PI / 2; x = 0; y = 0; l = e('len').value;
			var minx = miny = maxx = maxy = 0;
			for (i = 0; i < s.length; i++) {
				var func_list = assocc[s[i]];
				for (k in func_list) {
					[x, y, ca, l] = typeof funcs[func_list[k]] === 'function' ? funcs[func_list[k]](x, y, ca, l, dummy_ctx, da, dl) : [x, y, ca, l];
					[minx, miny, maxx, maxy] = [minx > x ? x : minx, miny > y ? y : miny, maxx < x ? x : maxx, maxy < y ? y : maxy];
				}
			}

			bw = maxx - minx + 2;
			bh = maxy - miny + 2;
			bc = make_canvas(bw, bh, alpha);
			draw_on_canvas(s, bc.getContext('2d'), funcs, assocc, -minx, -miny, -Math.PI / 2, e('len').value, da);

			px = (w - bw) / 2;
			py = (h - bh) / 2;

			putimg();
		}

		function calc() {
			e('result').innerHTML = '';
			draw(
				evolve_string(
					e('seed').value,
					parse_rules(e('rules').value),
					e('iter').value
				),
				parse_funcs(e('func').value)
			);
			e('dl_container').innerHTML = '<a href="' + e('cv').toDataURL("image/png") + '">Download</a>';
		}

		document.addEventListener('DOMContentLoaded', function () {
			w = e('cv').width;
			h = e('cv').height;
			e('calc').onclick = calc;
			e('show').onclick = function() { e('result').innerHTML = s; };//XXX this does not work after spliting calc, there no global anymore, fix it XXX
			for (prop in funcs) {
				e('func_help').innerHTML = e('func_help').innerHTML + '<abbr title="' + func_help[prop] + '">' + prop  + '</abbr>, ';
			}
			e('get_json').onclick = get_json;
			e('set_json').onclick = function () { set_json(prompt("Please enter JSON string", "")); };
			e('iter').onwheel = e('len').onwheel = e('deg').onwheel = e('alpha').onwheel = spinner;
			e('examples').onchange = function () { set_json(e('examples').value); };

			e('cv').onmousedown = function (e) { dragging = true; msx = e.clientX; msy = e.clientY; };
			e('cv').onmouseup = e('cv').onmout = function () { dragging = false; }; //XXX somehow does not work totally as expected
			e('cv').onmousemove = function (e) {
				if (dragging) {
					var dx = msx - e.clientX;
					var dy = msy - e.clientY;
					px -= dx;
					py -= dy;
					msx = e.clientX;
					msy = e.clientY;
					putimg();
				}
			};
		}, false);
	</script>
	<style type="text/css">
		body {color:lightgray;background-color:black;}
		canvas {border:1px solid cyan; margin-top:3px;}
		.spinner { width:3em; }
		#settings_table{border-collapse:collapse;margin:10px 0px;table-layout:fixed;width:400px;}
		#settings_table td {padding:0px 5px;}
		#settings_table td+td {border-left:2px solid gray;}
		#settings_table input {width:100%;}
		#examples_container {float:right;}
		#show {text-decoration:underline;}
		#result {word-wrap:break-word;width:120em;font-family:monospace;}
		#canvas_table {width:1035px;table-layout:fixed;}
	</style>
</head>

<body>
	<label>Seed: <input type="text" id="seed" value="[x][z][c]e"/></label> <br /><br />
	<table>
		<tr>
			<td>
				<label for="rules">Rules (one per line) <abbr title="<character>[.<probability>]=<replacement>; examples: &quot;a=[d]f&quot;;&quot;a.5=ab&quot;. Probabilities are not checked to add up to 1, if they are less, last defined has probability of 1 - <all other probabilities>, entries that appear after probabilities that take total above 1 will never happen. Characters are case sensitive.">?</abbr>:</label>
			</td>
			<td>
				<label for="func">Associated functions <abbr title="<character>=<func name>. Fucn names are those listed in &quot;Availabe functions&quot;. Not all used characters have to have functions assigned, unnasigned characters do not do anything, though of course they can impact evolution in rules. Same character can have multiple function associated with it, they will be executed in order they are defined.">?</abbr>:</label>
			</td>
			<td>Available functions:</td>
		</tr>
		<tr>
			<td>
<textarea id="rules" rows="10" cols="30">x=xw[D][A]zDc
z=zs[D][A]eAx
c=cd[W][S]eWz
e=ea[W]S[S]xc
D=Ddr
A=Aar
W=Wwr
S=Ssr</textarea>
			</td>
			<td>
<textarea id="func" rows="10" cols="30">r=rect
w=mu
a=ml
s=md
d=mr
[=push
]=pop
@=rep</textarea>
			</td>
			<td><div id="func_help"></div></td>
		</tr>
	</table>
	<table id="settings_table">
		<tr>
			<td><label for="iter">Iterations:</label></td>
			<td><label for="len">Length:</label></td>
			<td><label for="deg">Angle:</label></td>
			<td><label for="alpha">Alpha:</label></td>
		</tr>
		<tr>
			<td><input type="text" class="spinner" id="iter" value="5"/></td>
			<td><input type="text" class="spinner" id="len" value="8"/></td>
			<td><input type="text" class="spinner" id="deg" value="90"/></td>
			<td><input type="text" id="alpha" value="0.5"/></td>
		</tr>
	</table>
	<table id="canvas_table">
		<tr>
			<td>
				<div id="examples_container">
					<select id="examples">
						<option value="">- Examples -</option>
						<option value="{&quot;seed&quot;:&quot;0&quot;,&quot;rules&quot;:&quot;1=11\n0=1[0]0&quot;,&quot;func&quot;:&quot;1=fwd\n0=fwd\n[=push\n[=tl\n]=pop\n]=tr&quot;,&quot;iter&quot;:&quot;7.0&quot;,&quot;len&quot;:&quot;2.0&quot;,&quot;deg&quot;:&quot;45.0&quot;,&quot;alpha&quot;:&quot;1&quot;}">Wikipedia: basic tree</option>
						<option value="{&quot;seed&quot;:&quot;F&quot;,&quot;rules&quot;:&quot;F=F+F-F-F+F&quot;,&quot;func&quot;:&quot;F=fwd\n+=tl\n-=tr&quot;,&quot;iter&quot;:&quot;3.0&quot;,&quot;len&quot;:&quot;5.0&quot;,&quot;deg&quot;:&quot;90.0&quot;,&quot;alpha&quot;:&quot;1&quot;}">Wikipedia: Koch curve</option>
						<option value="{&quot;seed&quot;:&quot;A&quot;,&quot;rules&quot;:&quot;A=B-A-B\nB=A+B+A&quot;,&quot;func&quot;:&quot;A=fwd\nB=fwd\n+=tl\n-=tr&quot;,&quot;iter&quot;:&quot;7.0&quot;,&quot;len&quot;:&quot;2.0&quot;,&quot;deg&quot;:&quot;60.0&quot;,&quot;alpha&quot;:&quot;1&quot;}">Wikipedia: Sierpinski triangle</option>
						<option value="{&quot;seed&quot;:&quot;FX&quot;,&quot;rules&quot;:&quot;X=X+YF\nY=FX-Y&quot;,&quot;func&quot;:&quot;F=fwd\n+=tl\n-=tr&quot;,&quot;iter&quot;:&quot;12.0&quot;,&quot;len&quot;:&quot;4.0&quot;,&quot;deg&quot;:&quot;90.0&quot;,&quot;alpha&quot;:&quot;1&quot;}">Wikipedia: Dragon curve</option>
						<option value="{&quot;seed&quot;:&quot;X&quot;,&quot;rules&quot;:&quot;F=FF\nX=F-[[X]+X]+F[+FX]-X&quot;,&quot;func&quot;:&quot;F=fwd\n+=tl\n-=tr\n[=push\n]=pop&quot;,&quot;iter&quot;:&quot;5.0&quot;,&quot;len&quot;:&quot;4.0&quot;,&quot;deg&quot;:&quot;25.0&quot;,&quot;alpha&quot;:&quot;1&quot;}">Wikipedia: Fractal plant</option>
						<option value="{&quot;seed&quot;:&quot;[x][z]v&quot;,&quot;rules&quot;:&quot;x=rAx\nv=rDv\nz=rWz\nA=a[z]A\nD=d[z]D\nW=wW&quot;,&quot;func&quot;:&quot;r=rect\nw=mu\na=ml\ns=md\nd=mr\n[=push\n]=pop&quot;,&quot;iter&quot;:&quot;15&quot;,&quot;len&quot;:&quot;2&quot;,&quot;deg&quot;:&quot;90&quot;,&quot;alpha&quot;:&quot;0.4&quot;}">&quot;City&quot;</option>
						<option value="{&quot;seed&quot;:&quot;[x][z][c]e&quot;,&quot;rules&quot;:&quot;x.6=xrw[D][A]zDc\nx.4=x\nz.6=zrs[D][A]eAx\nz.4=z\nc.6=crd[W][S]eWz\nc.4=c\ne.6=era[W]S[S]xc\ne.4=e\nD=Dd\nA=Aa\nW=Ww\nS=Ss&quot;,&quot;func&quot;:&quot;r=rect\nw=mu\na=ml\ns=md\nd=mr\n[=push\n]=pop\n@=rep&quot;,&quot;iter&quot;:&quot;12&quot;,&quot;len&quot;:&quot;2&quot;,&quot;deg&quot;:&quot;90&quot;,&quot;alpha&quot;:&quot;0.2&quot;}">Continents</option>
						<option value="{&quot;seed&quot;:&quot;[x][z][c]e&quot;,&quot;rules&quot;:&quot;x=xw[D][A]zDc\nz=zs[D][A]eAx\nc=cd[W][S]eWz\ne=ea[W]S[S]xc\nD=Ddr\nA=Aar\nW=Wwr\nS=Ssr&quot;,&quot;func&quot;:&quot;r=rect\nw=mu\na=ml\ns=md\nd=mr\n[=push\n]=pop\n@=rep&quot;,&quot;iter&quot;:&quot;6.0&quot;,&quot;len&quot;:&quot;8&quot;,&quot;deg&quot;:&quot;90&quot;,&quot;alpha&quot;:&quot;0.2&quot;}">Continents Base</option>
						<option value="{&quot;seed&quot;:&quot;f&quot;,&quot;rules&quot;:&quot;f.6=f[i]f\nf.1=Af\nf.1=Sf\nf.1=Wf\nf.1=Df\ni=[q][e][z]c\nq.2=a[e]r[z]q\nq.8=qa\ne.2=w[q]r[c]e\ne.8=ew\nz.2=s[q]r[c]z\nz.8=zs\nc.2=d[e]r[z]c\nc.8=cd\nD.4=Dd\nD.6=D\nA.4=Aa\nA.6=A\nW.4=Ww\nW.6=W\nS.4=Ss\nS.6=S&quot;,&quot;func&quot;:&quot;r=rect\nw=mu\na=ml\ns=md\nd=mr\n[=push\n]=pop\n@=rep&quot;,&quot;iter&quot;:&quot;20&quot;,&quot;len&quot;:&quot;3&quot;,&quot;deg&quot;:&quot;90&quot;,&quot;alpha&quot;:&quot;0.2&quot;}">Continents 2</option>
					</select>
					<input type="button" id="get_json" value="Get JSON" />
					<input type="button" id="set_json" value="Set JSON" />
				</div>
				<input type="button" value="Calculate" id="calc" />
			</td>
		</tr>
		<tr>
			<td>
				Result image: <span id="dl_container"></span><br /><canvas id="cv" width="1024" height="768"></canvas><br /><br />
				<div><span id="show">Show result string</span>:<br /><div id="result"></div></div> 
			</td>
		</tr>
	</table>
	<br /><br /><br /><br />
</body>
</html>
