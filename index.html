<html>
<head>
	<title>L-Systems Explorer</title>
	<script type="text/javascript" src="funcs.js"></script>
	<script type="text/javascript">
		var s;
		var stack = [];
		function e(id) {
			return document.getElementById(id);
		}

		function draw(s, assocc) {
			var w = e('cv').width;
			var h = e('cv').height;
			var ctx = e('cv').getContext('2d');
			var alpha = e('alpha').value;
			ctx.fillStyle = "rgba(0,0,0,1)";
			ctx.fillRect( 0 , 0 , w , h );
			ctx.rect( 0 , 0 , w , h );
			ctx.clip();
			ctx.fillStyle = "rgba(100,200,100," + alpha + ")";
			ctx.strokeStyle = "rgba(100,200,100,1)";

			dl = 1;
			da = Math.PI / 180 * e('deg').value;
			ia = -Math.PI / 2;

			ca = ia; x = w / 2; y = h / 2; l = e('len').value;
			for (i = 0; i < s.length; i++) {
				ctx.beginPath();
				[x, y, ca, l] = typeof funcs[assocc[s[i]]] === 'function' ? funcs[assocc[s[i]]](x, y, ca, l, ctx, da, dl) : [x, y, ca, l];
				ctx.stroke();
			}
		}

		function calc() {
			e('result').innerHTML = '';
			s = e('seed').value;
			var n = e('iter').value;
			var rs = {};
			var assocc = {};
			var ns = '';

			e('rules').value.split("\n").forEach(function (e) {
				[lhs, rhs] = e.split("=");
				[chr, prob] = lhs.split(".");
				if (typeof rs[chr] == 'undefined') {
					rs[chr] = {'ps':[], 'rs':[]};//probabilities, replacements
				}
				rs[chr]['ps'].push(prob ? +("0." + prob) : 0);
				rs[chr]['rs'].push(rhs);
			});

			for (chr in rs) {
				arr = rs[chr]['ps'].slice(0);
				rs[chr]['ps'] = arr.reduce(function (p, c, i) { p.push((i ? p[i - 1] : 0) + c); return p;}, []);
			}

			for (i = 0; i < n; i++) {
				ns = '';
				for (j = 0; j < s.length; j++) {
					p = rs[s[j]];
					idx = p ? ran(p['ps']) : 0;
					ns = ns + (p ? p['rs'][idx] : s[j]);
				}
				s = ns;
			}

			e('func').value.split("\n").forEach(function (e) {
				var parts = e.split("=");
				assocc[parts[0]] = parts[1];
			});

			draw(s, assocc);

			e('dl_container').innerHTML = '<a href="' + e('cv').toDataURL("image/png") + '">Download</a>';
		}

		function get_json() {
			alert(JSON.stringify({
				'seed':e('seed').value,
				'rules':e('rules').value,
				'func':e('func').value,
				'iter':e('iter').value,
				'len':e('len').value,
				'deg':e('deg').value,
			}));
		}

		function set_json(d) {
			if (!d) {
				return;
			}
			d = JSON.parse(d);
			e('seed').value = d['seed'];
			e('rules').value = d['rules'];
			e('func').value = d['func'];
			e('iter').value = d['iter'];
			e('len').value = d['len'];
			e('deg').value = d['deg'];
		}

		function spinner (ev) { ev.target.value = (+ev.target.value) + (ev.deltaY > 0 ? -1 : 1); ev.preventDefault(); }

		document.addEventListener('DOMContentLoaded', function () {
			e('calc').onclick = calc;
			e('show').onclick = function() { e('result').innerHTML = s; };
			for (prop in funcs) {
				e('func_help').innerHTML = e('func_help').innerHTML + '<abbr title="' + func_help[prop] + '">' + prop  + '</abbr>, ';
			}
			e('get_json').onclick = get_json;
			e('set_json').onclick = function () { set_json(prompt("Please enter JSON string", "")); };
			e('iter').onwheel = e('len').onwheel = e('deg').onwheel = spinner;
			e('examples').onchange = function () { set_json(e('examples').value); };
		}, false);
	</script>
	<style type="text/css">
		body {color:lightgray;background-color:black;}
		canvas {border:1px solid cyan; margin-top:3px;}
		.spinner { width:3em; }
		#settings_table{border-collapse:collapse;margin:10px 0px;table-layout:fixed;width:400px;}
		#settings_table td {padding:0px 5px;}
		#settings_table td+td {border-left:2px solid gray;}
		#settings_table input {width:100%;}
		#examples_container {float:right;}
		#show {text-decoration:underline;}
		#result {word-wrap:break-word;width:120em;font-family:monospace;}
		#canvas_table {width:1035px;table-layout:fixed;}
	</style>
</head>

<body>
	<label>Seed: <input type="text" id="seed" value="[x][z][c]e"/></label> <br /><br />
	<table>
		<tr>
			<td>
				<label for="rules">Rules (one per line) <abbr title="<character>[.<probability>]=<replacement>; examples: &quot;a=[d]f&quot;;&quot;a.5=ab&quot;. Probabilities are not checked to add up to 1, if they are less, last defined has probability of 1 - <all other probabilities>, entries that appear after probabilities that take total above 1 will never happen. Characters are case sensitive.">?</abbr>:</label>
			</td>
			<td>
				<label for="func">Associated functions <abbr title="<character>=<func name>. Fucn names are those listed in &quot;Availabe functions&quot;. Not all used characters have to have functions assigned, unnasigned characters do not do anything, though of course they can impact evolution in rules.">?</abbr>:</label>
			</td>
			<td>Available functions:</td>
		</tr>
		<tr>
			<td>
<textarea id="rules" rows="10" cols="30">x=xw[D][A]zDc
z=zs[D][A]eAx
c=cd[W][S]eWz
e=ea[W]S[S]xc
D=Ddr
A=Aar
W=Wwr
S=Ssr</textarea>
			</td>
			<td>
<textarea id="func" rows="10" cols="30">r=rect
w=mu
a=ml
s=md
d=mr
[=push
]=pop
@=rep</textarea>
			</td>
			<td><div id="func_help"></div></td>
		</tr>
	</table>
	<table id="settings_table">
		<tr>
			<td><label for="iter">Iterations:</label></td>
			<td><label for="len">Length:</label></td>
			<td><label for="deg">Angle:</label></td>
			<td><label for="alpha">Alpha:</label></td>
		</tr>
		<tr>
			<td><input type="text" class="spinner" id="iter" value="5"/></td>
			<td><input type="text" class="spinner" id="len" value="8"/></td>
			<td><input type="text" class="spinner" id="deg" value="90"/></td>
			<td><input type="text" id="alpha" value="0.5"/></td>
		</tr>
	</table>
	<table id="canvas_table">
		<tr>
			<td>
				<div id="examples_container">
					<select id="examples">
						<option value="">- Examples -</option>
						<option value="{&quot;seed&quot;:&quot;[x][z]v&quot;,&quot;rules&quot;:&quot;x=rAx\nv=rDv\nz=rWz\nA=a[z]A\nD=d[z]D\nW=wW&quot;,&quot;func&quot;:&quot;r=rect\nw=mu\na=ml\ns=md\nd=mr\n[=push\n]=pop&quot;,&quot;iter&quot;:&quot;15&quot;,&quot;len&quot;:&quot;2&quot;,&quot;deg&quot;:&quot;90&quot;}">&quot;City&quot;</option>
						<option value="{&quot;seed&quot;:&quot;[x][z][c]e&quot;,&quot;rules&quot;:&quot;x.6=xrw[D][A]zDc\nx.4=x\nz.6=zrs[D][A]eAx\nz.4=z\nc.6=crd[W][S]eWz\nc.4=c\ne.6=era[W]S[S]xc\ne.4=e\nD=Dd\nA=Aa\nW=Ww\nS=Ss&quot;,&quot;func&quot;:&quot;r=rect\nw=mu\na=ml\ns=md\nd=mr\n[=push\n]=pop\n@=rep&quot;,&quot;iter&quot;:&quot;12&quot;,&quot;len&quot;:&quot;2&quot;,&quot;deg&quot;:&quot;90&quot;}">Continents</option>
						<option value="{&quot;seed&quot;:&quot;f&quot;,&quot;rules&quot;:&quot;f.6=f[i]f\nf.1=Af\nf.1=Sf\nf.1=Wf\nf.1=Df\ni=[q][e][z]c\nq.2=a[e]r[z]q\nq.8=qa\ne.2=w[q]r[c]e\ne.8=ew\nz.2=s[q]r[c]z\nz.8=zs\nc.2=d[e]r[z]c\nc.8=cd\nD.4=Dd\nD.6=D\nA.4=Aa\nA.6=A\nW.4=Ww\nW.6=W\nS.4=Ss\nS.6=S&quot;,&quot;func&quot;:&quot;r=rect\nw=mu\na=ml\ns=md\nd=mr\n[=push\n]=pop\n@=rep&quot;,&quot;iter&quot;:&quot;20&quot;,&quot;len&quot;:&quot;3&quot;,&quot;deg&quot;:&quot;90&quot;}">Continents 2</option>
					</select>
					<input type="button" id="get_json" value="Get JSON" />
					<input type="button" id="set_json" value="Set JSON" />
				</div>
				<input type="button" value="Calculate" id="calc" />
			</td>
		</tr>
		<tr>
			<td>
				<br />Result image: <span id="dl_container"></span><br />
				<canvas id="cv" width="1024" height="768"></canvas>
				<br /><br />
				<div>
					<span id="show">Show result string</span>:<br />
					<div id="result"></div>
				</div> 
			</td>
		</tr>
	</table>
	<br /><br />
	<br /><br />
</body>
</html>
